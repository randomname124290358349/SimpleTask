<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Details</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <div class="app-container" style="flex-direction: column;">
        <!-- Header -->
        <div class="top-bar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <a href="/" class="btn btn-secondary" style="padding: 8px 12px;">‚Üê Back</a>
                <div class="status-badge" id="task-status">Loading...</div>
            </div>

            <div style="display: flex; gap: 10px; align-items: center;">
                <div class="timer" id="task-timer" style="margin-right: 15px;">00:00:00</div>
                <button class="btn btn-secondary" onclick="toggleDarkMode()" id="theme-toggle">üåô</button>
                <div id="task-actions">
                    <!-- Status toggle button will be injected here by JS -->
                </div>
                <button class="btn btn-danger" onclick="openDeleteTaskModal()" style="padding: 8px 12px;"
                    title="Delete Task">üóëÔ∏è</button>
            </div>
        </div>

        <!-- Main Content Vertical View -->
        <div class="content-scroll">
            <div class="task-detail-container">
                <!-- Task Title -->
                <div style="margin-bottom: 20px;">
                    <h1 id="task-title" class="page-title editable" onclick="enableInlineEdit('task-title', 'input')"
                        title="Click to edit">Loading...</h1>
                </div>

                <div id="task-meta" style="color: var(--text-secondary); margin-bottom: 30px; font-size: 14px;">
                    Loading meta...
                </div>

                <!-- Description -->
                <div class="card"
                    style="min-height: 100px; cursor: text; box-shadow: none; border: none; background: transparent; padding: 0; margin-bottom: 40px;">
                    <h3
                        style="margin-bottom: 15px; color: var(--text-secondary); font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                        Description</h3>
                    <div id="task-desc" class="editable" onclick="enableInlineEdit('task-desc', 'textarea')"
                        style="white-space: pre-wrap; color: var(--text-primary); font-size: 16px; line-height: 1.6; min-height: 50px;"
                        title="Click to edit">
                        Loading description...</div>
                </div>

                <!-- Chat -->
                <div class="chat-container">
                    <h3
                        style="margin-bottom: 20px; color: var(--text-secondary); font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                        Updates & Discussion</h3>

                    <div id="message-list" class="message-list"
                        style="max-height: 500px; padding: 0; margin-bottom: 20px;">
                        <!-- Messages will be loaded here -->
                    </div>

                    <div class="message-input-area" style="background: transparent; padding: 0; border: none;">
                        <input type="text" id="message-input" placeholder="Type a message..."
                            onkeypress="handleEnter(event)"
                            style="background: var(--card-background); box-shadow: var(--shadow-sm);">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                            <div id="ai-toggle-container" style="display: none; align-items: center; gap: 8px;">
                                <input type="checkbox" id="use-ai-toggle" checked
                                    onchange="toggleAIPreference(this.checked)">
                                <label for="use-ai-toggle"
                                    style="cursor: pointer; user-select: none; font-size: 14px; color: var(--text-secondary);">‚ú®
                                    Enhance with AI</label>
                            </div>
                            <button class="btn" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Message Modal -->
    <div id="delete-msg-modal" class="modal-overlay">
        <div class="modal" style="max-width: 400px;">
            <h2>Delete Message?</h2>
            <p>Are you sure you want to delete this message? This action cannot be undone.</p>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeDeleteMsgModal()">Cancel</button>
                <button class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Delete Task Modal -->
    <div id="delete-task-modal" class="modal-overlay">
        <div class="modal" style="max-width: 400px;">
            <h2>Delete Task?</h2>
            <p>Are you sure you want to delete this task? This action cannot be undone and will delete all
                associated
                messages.</p>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeDeleteTaskModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteTask()">Delete Task</button>
            </div>
        </div>
    </div>

    <script>
        window.TASK_ID = {{ task_id }};
    </script>
    <script type="module" src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script type="module">
        // Load task details on init
        document.addEventListener('DOMContentLoaded', () => {
            checkUser();
            loadTaskDetails(TASK_ID);
            loadMessages(TASK_ID);

            // Refresh messages every 5 seconds if no edits are active
            setInterval(() => {
                if (typeof activeMessageEdits === 'undefined' || Object.keys(activeMessageEdits).length === 0) {
                    loadMessages(TASK_ID);
                }
            }, 5000);

            // Update timer every second
            setInterval(updateTimer, 1000);
        });
    </script>
</body>

</html>